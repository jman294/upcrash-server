var model,highlightSelection=!0,saved=!1;NProgress.configure({showSpinner:!1});var es={js:{ace:ace.edit("jsedit"),typeTimer:-1,saveTimer:-1,container:document.getElementById("jscon"),check:document.getElementById("jscheck")},css:{ace:ace.edit("cssedit"),typeTimer:-1,saveTimer:-1,container:document.getElementById("csscon"),check:document.getElementById("csscheck")},html:{ace:ace.edit("htmledit"),typeTimer:-1,saveTimer:-1,container:document.getElementById("htmlcon"),check:document.getElementById("htmlcheck")}};function getSurroundingHtmlElement(e){for(var t=[],s=e,n=es.html.ace.env.editor.getCursorPosition(),o=n.row,l=s.length,a=-1;o--&&a++<l&&(a=s.indexOf("\n",a),!(i<0)););a+=n.column;for(var c=0;c<e.length-1&&c!==a;c++){var d=e.charAt(c);"<"===d&&"/"===e.charAt(c+1)?t.pop():"<"===d&&t.push(c)}if(0===t.length)return e;var r=0;for(r=t.pop();r<e.length&&">"!==e.charAt(r);r++);var m=r;return e.slice(0,m)+" data-upcrash"+e.slice(m)}for(var e in model=new Model(template,onModelChange),es.js.ace.getSession().setMode("ace/mode/javascript"),es.js.ace.getSession().setTabSize(2),es.js.ace.getSession().setUseSoftTabs(!0),es.css.ace.getSession().setMode("ace/mode/css"),es.html.ace.getSession().setMode("ace/mode/html"),es.html.ace.env.editor.selection.on("changeCursor",function(){highlightSelection&&resetIframe()}),es)es[e].ace.setShowPrintMargin(!1),es[e].ace.getSession().setUseWrapMode(!0),es[e].ace.setTheme("ace/theme/monokai"),es[e].ace.getSession().setUseWorker(model.lintCheck),es[e].ace.on("change",function(){clearTimeout(es[e].typeTimer),es[e].typeTimer=setTimeout(function(){updateModel()},1e3)}),es[e].ace.commands.addCommand({name:"showKeyboardShortcuts",bindKey:{win:"Ctrl-i",mac:"Command-i"},exec:function(e){fullScreenToggle()}});function resetIframe(){document.getElementsByTagName("iframe")[0].src="https://upcrash-serve.herokuapp.com/"+id,resizeIframe(dims[0].value,dims[1].value),model.clearConsole&&console.clear()}var result=document.getElementById("result"),fullSize=document.getElementById("fullsize"),resultPop=document.getElementById("resultpop"),dims=document.getElementsByClassName("iframedim"),WIDTH=0,HEIGHT=1;function setResultSize(){var e=document.getElementsByTagName("iframe")[0];dims[WIDTH].value=e.offsetWidth,dims[HEIGHT].value=e.offsetHeight}for(var t=0;t<dims.length;t++)dims[t].addEventListener("keydown",function(e){var t=parseInt(e.key);8===e.keyCode||39===e.keyCode||37===e.keyCode||65===e.keyCode&&e.ctrlKey||9===e.keyCode||isNaN(t)&&e.preventDefault()}),dims[t].addEventListener("input",function(e){var t=result.offsetWidth,s=result.offsetHeight,n=document.getElementsByTagName("iframe")[0];parseInt(dims[WIDTH].value)>parseInt(dims[1].value)?parseInt(dims[WIDTH].value)>t?n.style.transform="scale("+t/dims[WIDTH].value+")":n.style.transform="scale(1)":parseInt(dims[HEIGHT].value)>s?n.style.transform="scale("+s/dims[HEIGHT].value+")":n.style.transform="scale(1)",resizeIframe(dims[WIDTH].value,dims[HEIGHT].value)});function resizeIframe(e,t){e=parseInt(e),t=parseInt(t);var s=document.getElementsByTagName("iframe")[0],n=result.offsetWidth,o=result.offsetHeight;s.style.height=t+"px",s.style.width=e+"px",s.style.transform=t<e?n<e?"scale("+n/e+")":"scale(1)":o<t?"scale("+o/t+")":"scale(1)"}result.addEventListener("mouseenter",function(){setResultSize(),resultPop.style.display="block"}),result.addEventListener("mouseleave",function(){resultPop.style.display="none"});var refresh=document.getElementById("refresh");refresh.addEventListener("click",function(){resetIframe()}),(fullSize=document.getElementById("fullsize")).addEventListener("click",function(){var e=document.getElementsByTagName("iframe")[0];e.style.transform="scale(1)",e.style.width="100%",e.style.height="100%",dims[WIDTH].value=e.offsetWidth,dims[HEIGHT].value=e.offsetHeight});var fullScreen=document.getElementById("fullsizerly"),isFullScreen=!1;function fullScreenToggle(){var e;(isFullScreen=!isFullScreen)?(fullScreen.src="images/downsize.png",result.style.left="0",(e=document.getElementsByTagName("iframe")[0]).style.transform="scale(1)",e.style.width="100%",e.style.height="100%",dims[WIDTH].value=e.offsetWidth,dims[HEIGHT].value=e.offsetHeight):(fullScreen.src="images/fullsize.png",result.style.left="50%",(e=document.getElementsByTagName("iframe")[0]).style.transform="scale(1)",e.style.width="100%",e.style.height="100%",dims[WIDTH].value=e.offsetWidth,dims[HEIGHT].value=e.offsetHeight)}fullScreen.addEventListener("click",fullScreenToggle),Mousetrap.bind(["command+i","ctrl+i"],function(e){fullScreenToggle()}),Mousetrap.bind(["command+1","ctrl+1"],function(e){console.log("preset 1")});for(var presets=document.getElementsByClassName("preset"),i=0;i<presets.length;i++)presets[i].addEventListener("click",function(e){var t=e.target.getAttribute("data-pwidth"),s=e.target.getAttribute("data-pheight");resizeIframe(t,s),setResultSize(t,s)});var contentBody=document.getElementById("body"),checkBoxes=document.getElementsByClassName("check");for(i=0;i<checkBoxes.length;i++){var el=checkBoxes[i];el.addEventListener("change",function(e){var t=contentBody.children.length-1;if(e.target.checked)switch(es.js.check.disabled=!1,es.css.check.disabled=!1,es.html.check.disabled=!1,e.target.id){case"jscheck":showJsEditor(t);break;case"csscheck":showCssEditor(t);break;case"htmlcheck":showHtmlEditor(t)}else switch(e.target.id){case"jscheck":hideJsEditor(t);break;case"csscheck":hideCssEditor(t);break;case"htmlcheck":hideHtmlEditor(t)}es.js.ace.resize(),es.css.ace.resize(),es.html.ace.resize()})}function showJsEditor(e){model.setProp("jsShow",!0),2===e?(es.js.container.style.top="0%",es.js.container.style.bottom="66.66%",es.css.container.style.top="33.33%",es.css.container.style.bottom="33.33%",es.html.container.style.top="66.66%",es.html.container.style.bottom="0%"):(es.js.container.style.top="0%",es.js.container.style.bottom="50%",contentBody.firstElementChild.style.top="50%",contentBody.firstElementChild.style.bottom="0%"),contentBody.insertBefore(es.js.container,contentBody.firstChild)}function showHtmlEditor(e){model.setProp("htmlShow",!0),2===e?(es.js.container.style.top="0%",es.js.container.style.bottom="66.66%",es.css.container.style.top="33.33%",es.css.container.style.bottom="33.33%",es.html.container.style.top="66.66%",es.html.container.style.bottom="0%"):(es.html.container.style.top="50%",es.html.container.style.bottom="0%",contentBody.firstElementChild.style.top="0%",contentBody.firstElementChild.style.bottom="50%"),contentBody.insertBefore(es.html.container,contentBody.firstChild)}function showCssEditor(e){model.setProp("cssShow",!0),2===e?(es.js.container.style.top="0%",es.js.container.style.bottom="66.66%",es.css.container.style.top="33.33%",es.css.container.style.bottom="33.33%",es.html.container.style.top="66.66%",es.html.container.style.bottom="0%"):contentBody.firstElementChild.id.includes("html")?(es.css.container.style.top="0%",es.css.container.style.bottom="50%",contentBody.firstElementChild.style.top="50%",contentBody.firstElementChild.style.bottom="0%"):(es.css.container.style.top="50%",es.css.container.style.bottom="0%",contentBody.firstElementChild.style.top="0%",contentBody.firstElementChild.style.bottom="50%"),contentBody.insertBefore(es.css.container,contentBody.firstChild)}function hideJsEditor(e){model.setProp("jsShow",!1),contentBody.removeChild(es.js.container),3===e?(es.css.container.style.top="0%",es.css.container.style.bottom="50%",es.html.container.style.top="50%",es.html.container.style.bottom="0%"):2===e&&(contentBody.firstElementChild.style.top="0%",contentBody.firstElementChild.style.bottom="0%",contentBody.firstElementChild.id.includes("css")?es.css.check.disabled=!0:es.html.check.disabled=!0),es.js.check.checked=!1}function hideHtmlEditor(e){model.setProp("htmlShow",!1),contentBody.removeChild(es.html.container),3===e?(es.js.container.style.top="0%",es.js.container.style.bottom="50%",es.css.container.style.top="50%",es.css.container.style.bottom="0%"):2===e&&(contentBody.firstElementChild.style.top="0%",contentBody.firstElementChild.style.bottom="0%",contentBody.firstElementChild.id.includes("js")?es.js.check.disabled=!0:es.css.check.disabled=!0),es.html.check.checked=!1}function hideCssEditor(e){model.setProp("cssShow",!1),contentBody.removeChild(es.css.container),3===e?(es.js.container.style.top="0%",es.js.container.style.bottom="50%",es.html.container.style.top="50%",es.html.container.style.bottom="0%"):2===e&&(contentBody.firstElementChild.style.top="0%",contentBody.firstElementChild.style.bottom="0%",contentBody.firstElementChild.id.includes("html")?es.html.check.disabled=!0:es.js.check.disabled=!0),es.css.check.checked=!1}var saveNotifier=document.getElementById("savenoti");function updateModel(){var e=es.js.ace.session.getValue();if(model.willChange("js",e))if(usingJSTranspiler){var t=compileJS(e,jsLang.selectedIndex);!1===t||model.setProp("js",t),model.setProp("uncompiledJS",e)}else model.setProp("js",e),model.setProp("uncompiledJS","");var s=es.html.ace.session.getValue();if(model.willChange("html",s))if(usingHtmlTranspiler){var n=compileHtml(s,htmlLang.selectedIndex);!1===n||model.setProp("html",n),model.setProp("uncompiledHTML",s)}else model.setProp("html",s),model.setProp("uncompiledHTML","");var o=es.css.ace.session.getValue();if(model.willChange("css",o))if(usingCssTranspiler){var l=compileCss(o,cssLang.selectedIndex);!1===l||model.setProp("css",l),model.setProp("uncompiledCSS",o)}else model.setProp("css",o),model.setProp("uncompiledCSS","")}function onModelChange(e){saveNotifier.innerHTML="Unsaved!",save("js"===e||"html"===e||"css"===e?resetIframe:null)}function save(t){function s(){NProgress.start();var e=new XMLHttpRequest;e.addEventListener("load",function(){403!==e.status?400<=e.status?(saveNotifier.style.display="inline-block",saveNotifier.innerHTML="Cannot Save!",saveNotifier.classList.remove("good","ok"),saveNotifier.classList.add("bad")):(saveNotifier.style.display="inline-block",saveNotifier.innerHTML="Saved!",console.log("%csaved!","color: red"),saveNotifier.classList.add("good"),saveNotifier.classList.remove("bad","ok")):setNewId(s)}),e.addEventListener("error",function(){saveNotifier.style.display="inline-block",saveNotifier.innerHTML="Cannot Save!",saveNotifier.classList.remove("good","ok"),saveNotifier.classList.add("bad")}),e.addEventListener("loadend",function(){NProgress.done(),t&&t()}),e.open("POST","/save/"+id),e.send(JSON.stringify(model))}navigator.onLine?"%ID%"===id?setNewId(s):s():(saveNotifier.style.display="inline-block",saveNotifier.innerHTML="Offline!",saveNotifier.classList.add("ok"),saveNotifier.classList.remove("good","bad"))}function setNewId(e){var t=new XMLHttpRequest;t.addEventListener("load",function(){id=JSON.parse(this.responseText).newId,history.pushState(null,"","/"+id),e()}),t.open("GET","/new"),t.send()}window.onload=function(){setResultSize()};var exportTemplate='<!DOCTYPE html>\r\n<html>\r\n\t<head>\r\n\t\t<meta charset="UTF-8">\r\n\t\t<meta name="viewport" content="width=device-width,initial-scale=1">\r\n\t\t<link rel="stylesheet" href="stylesheet.css" type="text/css">\r\n\t\t%STYLE%\r\n\t</head>\r\n\t<body>\r\n\t\t%HTML%\r\n\t\t%SCRIPT%\r\n\t</body>\r\n</html>',styleTemplate="<style>%CSS%</style>",scriptTemplate="<script>%JS%<\/script>",aboutButton=document.getElementById("aboutbutton"),modalItems=document.getElementsByClassName("modali"),modalOver=modalItems[0],htmlOutputArea=document.getElementById("exporthtmltextarea"),cssOutputArea=document.getElementById("exportcsstextarea"),jsOutputArea=document.getElementById("exportjstextarea"),includeCssCheck=document.getElementById("includecss"),includeJsCheck=document.getElementById("includejs"),downloadButton=document.getElementById("download"),aboutModalState=!1;function fillInFields(){var e=exportTemplate.replace("%HTML%",model.html);e=includeJsCheck.checked?e.replace("%SCRIPT%",scriptTemplate.replace("%JS%",model.js)):e.replace("%SCRIPT%",""),e=includeCssCheck.checked?e.replace("%STYLE%",styleTemplate.replace("%CSS%",model.css)):e.replace("%STYLE%",""),htmlOutputArea.value=e,cssOutputArea.value=model.css,jsOutputArea.value=model.js}aboutButton.addEventListener("click",function(){if(aboutModalState=!aboutModalState){fillInFields();for(var e=0;e<modalItems.length;e++)modalItems[e].style.display="block";"A"==modal.lastElementChild.nodeName&&modal.removeChild(modal.lastElementChild)}else for(e=0;e<modalItems.length;e++)modalItems[e].style.display="none"}),modalOver.addEventListener("click",function(){aboutModalState=!1;for(var e=0;e<modalItems.length;e++)modalItems[e].style.display="none"}),includeCssCheck.addEventListener("click",function(){fillInFields()}),includeJsCheck.addEventListener("click",function(){fillInFields()}),downloadButton.addEventListener("click",function(){var e=new JSZip;e.file("index.html",exportTemplate.replace("%SCRIPT%","").replace("%STYLE%","").replace("%HTML%",model.html)),e.file("index.js",model.js),e.file("style.css",model.css),e.generateAsync({type:"blob"}).then(function(e){var t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download="website.zip",s.innerHTML="Click here to download the file","A"==modal.lastElementChild.nodeName?modal.lastElementChild.href=t:modal.appendChild(s)})});var newLink=document.getElementById("new");newLink.addEventListener("click",function(e){for(var t in e.preventDefault(),es)es[t].ace.setValue("");setNewId(function(){})});var cloneLink=document.getElementById("clone");cloneLink.addEventListener("click",function(e){e.preventDefault(),setNewId(function(){})});for(var JS=0,HTML=1,CSS=2,settings=document.getElementsByClassName("set"),exits=document.getElementsByClassName("exit"),conheads=document.getElementsByClassName("conhead"),exit=0;exit<exits.length;exit++)exits[exit].addEventListener("click",function(e){e.target.parentElement.style.display="none"});for(var conhead=0;conhead<conheads.length;conhead++)conheads[conhead].addEventListener("click",function(e){e.target.parentElement.firstElementChild.style.display="block"});var loadType=document.getElementById("loadtype");loadType.addEventListener("change",function(e){model.setProp("loadType",e.target.selectedIndex)});var jsLang=document.getElementById("jslang"),usingJSTranspiler=!1;jsLang.addEventListener("change",function(e){model.setProp("jsLang",e.target.selectedIndex),usingJSTranspiler=0!==e.target.selectedIndex,conheads[JS].innerHTML=e.target.value});var htmlLang=document.getElementById("htmllang"),usingHtmlTranspiler=!1;htmlLang.addEventListener("change",function(e){model.setProp("htmlLang",e.target.selectedIndex),usingHtmlTranspiler=0!==e.target.selectedIndex,conheads[HTML].innerHTML=e.target.value});var highlightCheck=document.getElementById("highlightel");highlightCheck.addEventListener("change",function(e){highlightElement=e.target.checked,model.setProp("highlightElement",e.target.checked)});var usingCssTranspiler,cssLang=document.getElementById("csslang");cssLang.addEventListener("change",function(e){model.setProp("cssLang",e.target.selectedIndex),usingCssTranspiler=0!==e.target.selectedIndex,conheads[CSS].innerHTML=e.target.value});var lintCheck=document.getElementById("lintcheck");lintCheck.addEventListener("change",function(e){for(var t in model.setProp("lintCheck",e.target.checked),es)es[t].ace.getSession().setUseWorker(e.target.checked)});var consoleClearCheck=document.getElementById("consolecheck");function compileJS(e,t){switch(t){case 0:return e;case 1:return Babel.transform(e,{presets:["es2015"]}).code;case 2:return Babel.transform(CoffeeScript.compile(e),{presets:["es2015"]}).code}}consoleClearCheck.addEventListener("change",function(e){model.setProp("clearConsole",e.target.checked)}),loadType.selectedIndex=model.loadType,jsLang.selectedIndex=model.jsLang,usingJSTranspiler=0!==jsLang.selectedIndex,conheads[JS].innerHTML=jsLang.options[model.jsLang].value,htmlLang.selectedIndex=model.htmlLang,conheads[HTML].innerHTML=htmlLang.options[model.htmlLang].value,highlightCheck.checked=model.highlightElement,highlightSelection=model.highlightElement,cssLang.selectedIndex=model.cssLang,conheads[CSS].innerHTML=cssLang.options[model.cssLang].value;var numEditors=contentBody.children.length-1;function Model(e,t){for(var s in this.js="",this.html="",this.css="",this.uncompiledJS="",this.uncompiledHTML="",this.uncompiledCSS="",this.jsShow=!0,this.htmlShow=!0,this.cssShow=!0,this.loadType=3,this.jsLang=0,this.htmlLang=0,this.highlightElement=!1,this.cssLang=0,this.lintCheck=!0,this.clearConsole=!0,this.changed=t,this.setProp=function(e,t){return t===this[e]||(this[e]=t,this.changed(e),!1)},this.willChange=function(e,t){return t!==this[e]},e)this[s]=e[s]}model.htmlShow||hideHtmlEditor(numEditors),numEditors=contentBody.children.length-1,model.jsShow||hideJsEditor(numEditors),numEditors=contentBody.children.length-1,model.cssShow||hideCssEditor(numEditors),lintCheck.checked=model.lintCheck,usingJSTranspiler?es.js.ace.setValue(model.uncompiledJS,-1):es.js.ace.setValue(model.js),es.html.ace.setValue(model.html,-1),es.css.ace.setValue(model.css,-1);